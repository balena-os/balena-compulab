From 51b383f3e72bd2866261be723d38e324b2b1e128 Mon Sep 17 00:00:00 2001
From: Vicentiu Galanopulo <vicentiu@balena.io>
Date: Fri, 3 Sep 2021 11:59:17 +0200
Subject: [PATCH] Integrate-with-Balena-u-boot-environment

Upstream-Status: Inappropriate [configuration]
Signed-off-by: Vicentiu Galanopulo <vicentiu@balena.io>
---
 configs/cl-som-imx8_defconfig |  4 ++++
 include/configs/cl-som-imx8.h | 20 ++++++++++++++++----
 2 files changed, 20 insertions(+), 4 deletions(-)

diff --git a/configs/cl-som-imx8_defconfig b/configs/cl-som-imx8_defconfig
index 716d33d3de..ca1ca6ea48 100644
--- a/configs/cl-som-imx8_defconfig
+++ b/configs/cl-som-imx8_defconfig
@@ -105,3 +105,7 @@ CONFIG_DM_VIDEO=y
 CONFIG_SYS_WHITE_ON_BLACK=y
 CONFIG_VIDEO_IMX8M_DCSS=y
 CONFIG_VIDEO_IMX8M_HDMI=y
+CONFIG_CMD_UNZIP=y
+CONFIG_CMD_IMPORTENV=y
+CONFIG_PARTITION_UUIDS=y
+CONFIG_CMD_PART=y
\ No newline at end of file
diff --git a/include/configs/cl-som-imx8.h b/include/configs/cl-som-imx8.h
index 99e00848c1..a0ae9fef50 100644
--- a/include/configs/cl-som-imx8.h
+++ b/include/configs/cl-som-imx8.h
@@ -64,7 +64,8 @@
 /* Initial environment variables */
 #define CONFIG_EXTRA_ENV_SETTINGS		\
 	"script=boot.scr\0" \
-	"image=Image\0" \
+	"image=Image.gz\0" \
+	"zip_addr=0x42480000\0" \
 	"console=ttymxc2,115200 earlycon=ec_imx6q,0x30880000,115200\0" \
 	"fdt_addr=0x43000000\0"			\
 	"fdt_high=0xffffffffffffffff\0"		\
@@ -77,10 +78,11 @@
 	"bootscript=echo Running bootscript from ${iface} ...; source\0"	\
 	"iface_boot=if run loadbootscript; then run bootscript; else if run loadimage; then run loadfdt;" \
 	" booti ${loadaddr} - ${fdt_addr}; fi; fi;\0"	\
-	"iface_args=setenv bootargs console=${console} root=${rootdev} rootwait rw \0"	\
+	"iface_args=setenv bootargs console=${console} root=${rootdev} ${resin_kernel_root} rootwait rw ${os_cmdline} \0"	\
 	"loadbootscript=load ${iface} ${dev}:${part} ${loadaddr} ${script}\0"	\
 	"loadfdt=load ${iface} ${dev}:${part} ${fdt_addr} ${fdt_file}\0"	\
-	"loadimage=load ${iface} ${dev}:${part} ${loadaddr} ${image}\0"	\
+	"loadimage=load ${iface} ${dev}:${part} ${zip_addr} ${image}; unzip ${zip_addr} ${loadaddr};\0"	\
+	"mmcroot=/dev/mmcblk${mmcdev}p2 rootwait rw;\0" \
 	"mmc_boot=setenv iface mmc; run ${iface}_pre; run ${iface}_init; run iface_args; run iface_boot\0"	\
 	"mmc_init=mmc rescan\0"	\
 	"mmc_pre=setenv iface mmc; setenv dev ${mmcdev}; setenv rootdev /dev/mmcblk${mmcdev}p2\0"	\
@@ -89,7 +91,17 @@
 	"usb_pre=setenv iface usb; setenv dev 0; setenv rootdev /dev/sda2\0"	\
 
 #define CONFIG_BOOTCOMMAND \
-	"setenv mmcdev 1; run mmc_boot; run usb_boot; setenv mmcdev 0; run mmc_boot;"
+	"setenv resin_uboot_devices ${mmcdev};" \
+	"setenv resin_kernel_load_addr ${loadaddr};" \
+	"run resin_set_kernel_root; run set_os_cmdline; " \
+	"setenv mmcdev ${resin_dev_index};" \
+	"setenv mmcbootpart ${resin_boot_part};" \
+	"run mmc_boot; echo ERROR Could not boot from emmc device ${mmcdev};"
+
+#ifdef CONFIG_ENV_SIZE
+#undef CONFIG_ENV_SIZE
+#define CONFIG_ENV_SIZE             0x6000
+#endif
 
 /* Link Definitions */
 #define CONFIG_LOADADDR			0x40480000
-- 
2.17.1

