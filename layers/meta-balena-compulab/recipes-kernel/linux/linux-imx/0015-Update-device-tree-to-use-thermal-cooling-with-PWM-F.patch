From e3da49b66f82b7b97d0b42f8d04b83d0badaa39c Mon Sep 17 00:00:00 2001
From: Vicentiu Galanopulo <vicentiu@balena.io>
Date: Thu, 14 Oct 2021 12:45:46 +0200
Subject: [PATCH] Update device tree to use thermal cooling with PWM FAN

Add pwm-fan dts node and integrate it in the thermal-zones node.
Trip values are set for 60 and 65 deg. Celsius

Upstream-status: Inappropriate [configuration]
Signed-off-by: Vicentiu Galanopulo <vicentiu@balena.io>
---
 arch/arm64/boot/dts/freescale/imx8mq.dtsi | 32 +++++++++++++++++++++++
 1 file changed, 32 insertions(+)

diff --git a/arch/arm64/boot/dts/freescale/imx8mq.dtsi b/arch/arm64/boot/dts/freescale/imx8mq.dtsi
index 183499d5dedd..2ac3419fb720 100755
--- a/arch/arm64/boot/dts/freescale/imx8mq.dtsi
+++ b/arch/arm64/boot/dts/freescale/imx8mq.dtsi
@@ -221,6 +221,15 @@
 		method = "smc";
 	};
 
+	fan0: pwm-fan {
+		compatible = "pwm-fan";
+		cooling-min-state = <0>;
+		cooling-max-state = <2>;
+		#cooling-cells = <2>;
+		pwms = <&pwm2 0 40000 0>;
+		cooling-levels = <0 170 255>;
+	};
+
 	thermal-zones {
 		cpu-thermal {
 			polling-delay-passive = <250>;
@@ -234,6 +243,18 @@
 					type = "passive";
 				};
 
+				cpu_alert1: trip1 {
+					temperature = <60000>;
+					hysteresis = <1000>;
+					type = "passive";
+				};
+
+				cpu_alert2: trip2 {
+					temperature = <65000>;
+					hysteresis = <2000>;
+					type = "passive";
+				};
+
 				cpu_crit: cpu-crit {
 					temperature = <90000>;
 					hysteresis = <2000>;
@@ -250,6 +271,17 @@
 						<&A53_2 THERMAL_NO_LIMIT THERMAL_NO_LIMIT>,
 						<&A53_3 THERMAL_NO_LIMIT THERMAL_NO_LIMIT>;
 				};
+
+				map1 {
+					trip = <&cpu_alert1>;
+					cooling-device = <&fan0 0 1>;
+				};
+
+				map2 {
+					trip = <&cpu_alert2>;
+					cooling-device = <&fan0 1 2>;
+				};
+
 			};
 		};
 	};
-- 
2.17.1

