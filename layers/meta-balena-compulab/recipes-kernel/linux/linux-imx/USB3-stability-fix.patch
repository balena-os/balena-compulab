From f3dd802ff9c514e56739ed38126f773d0c040e19 Mon Sep 17 00:00:00 2001
From: Vicentiu Galanopulo <vicentiu@balena.io>
Date: Wed, 6 Oct 2021 16:19:23 +0200
Subject: [PATCH] Let's fix the USB

This patch fixes host USB3 crashing when writing to multiple
drives. Please see https://community.nxp.com/thread/511218

[  124.983731] xhci-hcd xhci-hcd.1.auto: xHCI host not responding to stop endpoint command.
[  124.999954] xhci-hcd xhci-hcd.1.auto: xHCI host controller not responding, assume dead
[  125.007888] xhci-hcd xhci-hcd.1.auto: xHCI host not responding to stop endpoint command.
[  125.016265] xhci-hcd xhci-hcd.1.auto: HC died; cleaning up
[  125.016332] usb 4-1.2.3: Failed to set U1 timeout to 0x0,error code -22
[  125.021875] usb 3-1: USB disconnect, device number 2
[  125.028505] usb 4-1.2.3: usb_reset_and_verify_device Failed to disable LPM

Upstream-Status: Pending
Signed-off-by: Li Jun <jun.li@nxp.com>
Signed-off-by: Vicentiu Galanopulo <vicentiu@balena.io>
---
 drivers/usb/dwc3/core.c | 12 +++++++++++-
 drivers/usb/dwc3/core.h |  1 +
 2 files changed, 12 insertions(+), 1 deletion(-)

diff --git a/drivers/usb/dwc3/core.c b/drivers/usb/dwc3/core.c
index 9ecd2d0f6737..257d87cc86d7 100644
--- a/drivers/usb/dwc3/core.c
+++ b/drivers/usb/dwc3/core.c
@@ -1075,7 +1075,17 @@ static int dwc3_core_init(struct dwc3 *dwc)
 
 		if (dwc->dis_tx_ipgap_linecheck_quirk)
 			reg |= DWC3_GUCTL1_TX_IPGAP_LINECHECK_DIS;
-
+		/*
+		* Synopsys STAR:
+		* USB3.0 HC died when read and write at the same
+		* time with park mode.
+		* It has advantage only a single async EP is
+		* active, which is meaningless for application;
+		* So disable park mode and synopsys will change
+		* the default value of park mode to be disabled
+		* in next release.
+		*/
+		reg |= DWC3_GUCTL1_PARKMODE_DISABLE;
 		dwc3_writel(dwc->regs, DWC3_GUCTL1, reg);
 	}
 
diff --git a/drivers/usb/dwc3/core.h b/drivers/usb/dwc3/core.h
index 26ddb8d65745..69a510967f43 100644
--- a/drivers/usb/dwc3/core.h
+++ b/drivers/usb/dwc3/core.h
@@ -269,6 +269,7 @@
 #define DWC3_GUCTL1_TX_IPGAP_LINECHECK_DIS	BIT(28)
 #define DWC3_GUCTL1_DEV_L1_EXIT_BY_HW	BIT(24)
 #define DWC3_GUCTL1_PARKMODE_DISABLE_SS	BIT(17)
+#define DWC3_GUCTL1_PARKMODE_DISABLE   BIT(17) | BIT(16) | BIT(15)
 
 /* Global Status Register */
 #define DWC3_GSTS_OTG_IP	BIT(10)
-- 
2.17.1

